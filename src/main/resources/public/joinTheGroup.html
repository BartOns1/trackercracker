<!DOCTYPE html>

<html lang="en">
<head>
    <title>Join Your Group</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous"/>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>

    <meta charset="UTF-8"/>
    <style>
    #map {
        height: 400px;
        width: 100%;
        background: red;
    }
    </style>
</head>
<body>
<h1 class="jumbotron" id ="main-title">Participate</h1>

<div id="ultimate-parent" class="container">
    <div id="register-form">
    <table class="table table-striped" id = "legend">
        <thead>
        <tr>
            <th>track Label</th>
            <th>color</th>
            <th>Desactivate Your tracking</th>
        </tr>
        </thead>
        <tbody id="participant-list-data">
        </tbody>
    </table>

    <form id="participant-create-form">
        <div class="form-group">
            <label for="group">Please enter The name of your track group you want to join:</label>
            <input class="form-control" id="group" name="group"/>
        </div>
        <div class="form-group">
            <label for="label">Enter a track name to label your track:</label>
            <input class="form-control" id="label" name="label"/>
        </div>

        <input type="submit" class="btn btn-primary" value="Create">
    </form>
    </div>
</div>
<div id="map"></div>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvqVBvWAak2PLh0YEEwWHx780LEXX72kk&callback=initMap">
</script>

<script type="text/javascript">

            $("#participant-create-form").submit(function(e) {
                e.preventDefault();

                var thisLabel=$('#label').val();
                var thisGroup=$('#group').val();


               var g = $.ajax({
                    method: 'get',
                    url: '/api/group/' + thisGroup,
                    dataType:'json',
                    async: false
                    }).responseJSON;

                let p = {
                    label: thisLabel,
                    group: g
                };

                if (g==null || g==undefined){alert('This group name does not exist, type an existing tracking group name or make a new group');}

                else {

                    //let linkRegister = document.getElementById('register-form');
                    //var linkParent = document.getElementById('ultimate-parent');
                    //linkParent.removeChild(linkRegister);
                  //  var linkH1 = document.getElementById('main-title');

                    var linkParent = $('#ultimate-parent');
                    linkParent.empty();
                    $('#main-title').html("tracking");



                    let $row= $('<tr>')
                        .append($('<th>').text("track names"))
                        .append($('<th>').text('track color'))
                        .append($('<th>').text('state'));
                    var $thead=$('<thead>').append($row);
                   // $table.append($thead);
                  //  console.log($table)

                        $.ajax({
                        method: 'post',
                        url: '/api/group/participant',
                        contentType: 'application/json',
                        data: JSON.stringify(p), // Better way to do this?
                        processData: false,
                        success: function () {
                            // Refresh data table

                            loadParticipants();

                        }
                    });

                }

                var uluru = {lat: 50.8505, lng: 4.7233};
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 12,
                    center: uluru,
                    //mapTypeId: 'terrain'
                });
                function loadParticipants() {
                    $.getJSON(`/api/group/${g.groupName}/participants`, function (participants) {
                        $("#participant-list-data").empty();
                        let $tbody=$('<tbody>');
                        for (let participant of participants) {
                            let $removeButton = $("<button>").addClass("btn").addClass("btn-danger").text("go underwater");
                            $removeButton.click(function(e) {
                                $.ajax({
                                    method: 'delete',
                                    url: `/api/group/participant/${participant.id}`,
                                    success: function(){
                                        loadParticipants();
                                    }
                                });
                            });
                                 let $row = $('<tr>')
                                .append($('<td>').text(participant.label))
                                .append($('<td>').text(participant.color));


                            if(participant.label==p.label){
                                $row.append($('<td>').append($removeButton));
                                }
                                else{
                                $row.append($('<td>'));
                                }
                            $tbody.append($row);

                        }
                        let  $table=$('<table>').append($thead).append($tbody).addClass("table table-striped");
                        linkParent.append($table);



                        ////initializing the map


                        function drawTraces(participants) {
                            for (let participant of participants) {
                                var coords = participant.coordinates;

                                var track = new google.maps.Polyline({
                                    map: map,
                                    path: coords.map((coordinate) => {
                                        return {lat: coordinate.latitude, lng: coordinate.longitude}
                                    }),
                                    geodesic: true,
                                    strokeColor: participant.color,
                                    strokeOpacity: 0.7,
                                    strokeWeight: 4
                                });

                            }

                        }
                        drawTraces(participants);



                    });



                }
                var infoWindow = new google.maps.InfoWindow;

                function getCoordinates() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            $.getJSON(`/api/group/participant/${thisLabel}`,function(thisParticipant) {
                                let coord = {
                                    timeStamp: 'todo',
                                    longitude: pos.lng,
                                    latitude: pos.lat
                                };

                                //ik slaag erin om de coordinaten toe te voegen aan het object thiParticipant, maar kan
                                //de update niet in de database wegschrijven, nochtans bestaat de id, dus update
                                //de tabel "coordinaten" is een embedded tabel van participanten
                                thisParticipant.coordinates.push(coord);
console.log(thisParticipant.id)
                                $.ajax({
                                    method: 'put',
                                    url: '/api/group/participant/' + thisLabel,
                                    contentType: 'application/json',
                                    data: JSON.stringify(thisParticipant), // Better way to do this?
                                    processData: false,
                                    success: function () {
                                        // Refresh data table


                                    }
                                });

                        })

                        }
                        , function () {
                            handleLocationError(true, infoWindow, map.getCenter());
                        }, {timeout: 10000})
                    } else {
                        // Browser doesn't support Geolocation
                        handleLocationError(false, infoWindow, map.getCenter());
                    }
                }
                getCoordinates();
                function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                    'Error: The Geolocation service failed.' :
                    'Error: Your browser doesn\'t support geolocation.');
                infoWindow.open(map);
            }



            });




        </script>

</body>
</html>